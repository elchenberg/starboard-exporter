package controllers

import (
	"github.com/prometheus/client_golang/prometheus"
	"sigs.k8s.io/controller-runtime/pkg/metrics"
)

const (
	metricNamespace = "starboard_exporter"
	metricSubsystem = "vulnerabilityreport"
)

// All metrics include these labels.
var commonLabels = []string{
	"report_name",
	"image_namespace",
	"image_repository",
	"image_tag",
	"image_digest",
}

// Gauge for each CVE present in an image.
var (
	vulnInfoLabels = append(
		commonLabels,
		"vulnerability_id",
		"vulnerable_resource_name",
		"installed_resource_version",
		"fixed_resource_version",
		"vulnerability_title",
		"vulnerability_link",
		"vulnerability_score",
		"severity",
	)

	VulnerabilityInfo = prometheus.NewGaugeVec(
		prometheus.GaugeOpts{
			Namespace: metricNamespace,
			Subsystem: metricSubsystem,
			Name:      "image_vulnerabilities",
			Help:      "Indicates the presence of a CVE in an image.",
		},
		vulnInfoLabels,
	)
)

// Gauge for the count of all vulnerabilities of a particular severity contained in an image.
var (
	vulnSummaryLabels = append(
		commonLabels,
		"severity",
	)

	VulnerabilitySummary = prometheus.NewGaugeVec(
		prometheus.GaugeOpts{
			Namespace: metricNamespace,
			Subsystem: metricSubsystem,
			Name:      "image_vulnerabilities_count",
			Help:      "Exposes the number of vulnerabilities of a particular severity per-image.",
		},
		vulnSummaryLabels,
	)
)

func init() {
	// Register custom metrics with the global prometheus registry
	metrics.Registry.MustRegister(VulnerabilityInfo, VulnerabilitySummary)
}
